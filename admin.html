<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prebuiltid | Admin</title>

  <link rel="stylesheet" href="admin.css">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = { 
      apiKey: "AIzaSyBkbXzURYKixz4R28OYMUOueA9ysG3Q1Lo",
      authDomain: "prebuiltid-website.firebaseapp.com",
      projectId: "prebuiltid-website",
      storageBucket: "prebuiltid-website.firebasestorage.app",
      messagingSenderId: "854871585546",
      appId: "1:854871585546:web:568400979292a0c31740f3",
      measurementId: "G-YS1Q1904H6"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.getAuth();
    const db = firebase.getFirestore();

    const ADMIN_EMAILS = ["prebuiltid@gmail.com"];
  </script>

</head>
<body>

<header id="header">
  <img src="Images/Prebuiltid.png" id="HIcon" alt="Logo">
  <h1 id="HH1">Prebuiltid Admin</h1>

  <nav>
    <ul>
      <li><a href="index.html">Kodu</a></li>
      <li><a href="#" class="active">Admin</a></li>
      <li><a href="#" id="logoutBtn">Logi välja</a></li>
    </ul>
  </nav>
</header>

<section>
  <h2>Toodete haldamine</h2>

  <div class="admin-box">
    <h3>Lisa uus toode</h3>

    <label>Nimi:</label>
    <input type="text" id="pName">

    <label>Hind (€):</label>
    <input type="number" id="pPrice" step="0.01">

    <label>Pilt (URL):</label>
    <input type="text" id="pImage">

    <label>Kategooria:</label>
    <input type="text" id="pCategory">

    <label>Kirjeldus:</label>
    <textarea id="pDescription"></textarea>

    <label>Kogus:</label>
    <input type="number" id="pQuantity" min="0">

    <button id="addProductBtn">Lisa toode</button>
  </div>

  <h3>Olemasolevad tooted</h3>
  <div id="productList"></div>
</section>

<section>
  <h2>Tellimused</h2>
  <div id="orderList"></div>
</section>

<script>
  firebase.onAuthStateChanged(auth, user => {
    if (!user) return location.href = "login.html";

    const email = user.email.toLowerCase();
    if (!ADMIN_EMAILS.includes(email)) {
      return location.href = "index.html";
    }
  });

  document.getElementById("logoutBtn").onclick = () => {
    firebase.signOut(auth).then(() => location.href = "login.html");
  };

  const productsRef = firebase.collection(db, "products");
  const ordersRef = firebase.collection(db, "orders");

  // Add product
  document.getElementById("addProductBtn").onclick = async () => {
    const name = pName.value.trim();
    const price = parseFloat(pPrice.value);
    const image = pImage.value.trim();
    const category = pCategory.value.trim();
    const description = pDescription.value.trim();
    const quantity = parseInt(pQuantity.value);

    if (!name || !price || !image || !category || !description || isNaN(quantity)) {
      alert("Täida kõik väljad!");
      return;
    }

    await firebase.addDoc(productsRef, {
      name, price, image, category, description, quantity,
      createdAt: firebase.serverTimestamp()
    });

    pName.value = "";
    pPrice.value = "";
    pImage.value = "";
    pCategory.value = "";
    pDescription.value = "";
    pQuantity.value = "";

    alert("Toode lisatud!");
  };

  // Load products
  firebase.onSnapshot(productsRef, snap => {
    const list = document.getElementById("productList");
    list.innerHTML = "";

    snap.forEach(doc => {
      const p = doc.data();

      const div = document.createElement("div");
      div.className = "product-item";
      div.innerHTML = `
        <strong>${p.name}</strong><br>
        Hind: €${p.price}<br>
        Kategooria: ${p.category}<br>
        Laos: ${p.quantity}<br>
        <button onclick="deleteProduct('${doc.id}')">Kustuta</button>
      `;

      list.appendChild(div);
    });
  });

  window.deleteProduct = async (id) => {
    if (!confirm("Kustuta toode?")) return;
    await firebase.deleteDoc(firebase.doc(db, "products", id));
  };

  firebase.onSnapshot(ordersRef, snap => {
    const list = document.getElementById("orderList");
    list.innerHTML = "";

    snap.forEach(doc => {
      const o = doc.data();

      const div = document.createElement("div");
      div.className = "order-item";

      div.innerHTML = `
        <strong>${o.email}</strong><br>
        Staatust: <select onchange="updateOrder('${doc.id}', this.value)">
          <option value="processing" ${o.status === "processing" ? "selected" : ""}>processing</option>
          <option value="completed" ${o.status === "completed" ? "selected" : ""}>completed</option>
          <option value="cancelled" ${o.status === "cancelled" ? "selected" : ""}>cancelled</option>
        </select>
        <br><br>
        <strong>Tooted:</strong><br>
        ${o.products.map(p => `${p.name} x ${p.qty}`).join("<br>")}
      `;

      list.appendChild(div);
    });
  });

  window.updateOrder = async (id, status) => {
    await firebase.updateDoc(firebase.doc(db, "orders", id), { status });
  };
</script>

</body>
</html>
